<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #333;
      color: #fff;
    }
    h1 {
      text-align: center;
    }
    #placementDropdown, #ordersTableContainer {
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #444;
    }
    button {
      background-color: red;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Kitchen Orders</h1>
  
  <div id="placementDropdown">
    <label for="placements">Select Kitchen:</label>
    <select id="placements" onchange="loadOrdersByPlacement()"></select>
  </div>

  <div id="ordersTableContainer">
    <h2>Orders</h2>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Food Item</th>
          <th>Table Number</th>
          <th>Category</th>
          <th>Notes</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


  <script>
     function checkEnteredUser(){
    const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const username = urlParams.get('username');
      const role = urlParams.get('role');
    if(!code || !username || !role){
      return window.location.href = "/menu/menu.html"
    }
    if(role =="kitchen staff" || role =="admin"){

    }else{
      return window.location.href = "/menu/menu.html"
    }
  }
  checkEnteredUser()
  </script>
  <script>
    function deleteOrder(id) {
      fetch('/api/delete-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id }),
      })
        .then(() => loadOrdersByPlacement())
        .catch((error) => {
          console.error('Error deleting order:', error);
          alert('An error occurred while deleting the order.');
        });
    }

    function updateOrderStatus(id, newStatus) {
      fetch('/api/update-order-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id, newStatus }),
      })
        .then(() => loadOrdersByPlacement())
        .catch((error) => {
          console.error('Error updating order status:', error);
          alert('An error occurred while updating order status.');
        });
    }

    function createActionButton(id, status) {
      const button = document.createElement('button');
      let newStatus = "";
      if (status === 'Sent to kitchen') {
        newStatus = "Cooking";
        button.textContent = 'Change status to cooking';
      } else if (status === 'Cooking') {
        newStatus = 'Sent to customer';
        button.textContent = 'Change status to sent to customer';
      } else if (status === "Sent to customer") {
        button.textContent = 'Delete';
      }

      button.addEventListener('click', () => {
        if (newStatus === "Sent to customer" || newStatus === "Cooking") {
          updateOrderStatus(id, newStatus);
        } else {
          deleteOrder(id);
        }
      });

      return button;
    }

    async function loadOrdersByPlacement() {
      const selectedPlacement = document.getElementById('placements').value;
      const ordersTableBody = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];

      try {
        let response;
        if (selectedPlacement) {
          response = await fetch(`/api/get-orders-by-placement/${selectedPlacement}`);
        } else {
          response = await fetch('/api/get-all-orders');
        }

        const orders = await response.json();
        orders.reverse(); // Show most recent orders first

        // Clear existing rows before adding new ones
        while (ordersTableBody.firstChild) {
          ordersTableBody.removeChild(ordersTableBody.firstChild);
        }

        // Populate orders in the table
        orders.forEach((order) => {
          const row = ordersTableBody.insertRow();
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.name}</td>
            <td>${order.tableNumber}</td>
            <td>${order.category}</td>
            <td>${order.note}</td>
            <td>${order.status}</td>
            <td></td>
          `;

          // Create and add the action button to the "Action" column
          const actionCell = row.cells[6];
          const actionButton = createActionButton(order.id, order.status);
          actionCell.appendChild(actionButton);
        });

      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    async function loadFilePlacements() {
      try {
        const response = await fetch('/api/get-file-placements');
        const { filePlacements } = await response.json();
        const placementsDropdown = document.getElementById('placements');

        // Populate the placement options in the dropdown
        filePlacements.forEach((placement) => {
          const option = document.createElement('option');
          option.value = placement;
          option.textContent = placement;
          placementsDropdown.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading file placements:', error);
      }
    }

    // Load file placements and populate the initial orders
    loadFilePlacements();
    loadOrdersByPlacement();
  </script>
</body>
</html>
